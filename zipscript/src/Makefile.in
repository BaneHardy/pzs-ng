prefix=@prefix@
datapath=/ftp-data
storage=/tmp/zipscript
bindir=$(prefix)/bin
binpath=../bin

CC=@CC@
CFLAGS=@CFLAGS@ -W -Wall -O2 @STATIC@ -g -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -I../include/ -I../../
LDFLAGS=@LDFLAGS@
UNIVERSAL=race-file.o zsfunctions.o mp3info.o
RM=rm -f

RD-OBJECTS=racedebug.o
ZS-OBJECTS=zipscript-c.o dizreader.o stats.o complete.o convert.o multimedia.o crc.o $(UNIVERSAL)
PD-OBJECTS=postdel.o dizreader.o stats.o convert.o multimedia.o $(UNIVERSAL)
RS-OBJECTS=racestats.o dizreader.o stats.o convert.o $(UNIVERSAL)
CU-OBJECTS=cleanup.o
DC-OBJECTS=datacleaner.o
UD-OBJECTS=pzsng-undupe.o
SC-OBJECTS=rescan.o dizreader.o stats.o convert.o complete.o crc.o multimedia.o $(UNIVERSAL)
CH-OBJECTS=ng-chmod.o
ZS-DEPEND=cleanup.o complete.o convert.o datacleaner.o postdel.o racestats.o rescan.o stats.o zipscript-c.o multimedia.o $(UNIVERSAL)

all: pzsng-undupe racedebug zipscript-c postdel racestats cleanup datacleaner rescan ng-chmod

$(ZS-DEPEND): ../conf/zsconfig.h

zipscript-c: $(ZS-OBJECTS) $(ZS-DEPEND)
	     $(CC) $(LDFLAGS) $(ZS-OBJECTS) -o $(binpath)/$@

racedebug: $(RD-OBJECTS)
	   $(CC) $(LDFLAGS) $(RD-OBJECTS) -o $(binpath)/$@

postdel: $(PD-OBJECTS)
	 $(CC) $(LDFLAGS) $(PD-OBJECTS) -o $(binpath)/$@

racestats: $(RS-OBJECTS)
	   $(CC) $(LDFLAGS) $(RS-OBJECTS) -o $(binpath)/$@

cleanup: $(CU-OBJECTS)
	 $(CC) $(LDFLAGS) $(CU-OBJECTS) -o $(binpath)/$@

datacleaner: $(DC-OBJECTS)
	     $(CC) $(LDFLAGS) $(DC-OBJECTS) -o $(binpath)/$@

pzsng-undupe: $(UD-OBJECTS)
	      $(CC) $(LDFLAGS) $(UD-OBJECTS) -o $(binpath)/$@

ng-chmod: $(CH-OBJECTS)
	      $(CC) $(LDFLAGS) $(CH-OBJECTS) -o $(binpath)/$@

rescan: $(SC-OBJECTS)
	$(CC) $(LDFLAGS) $(SC-OBJECTS) -o $(binpath)/$@

install:
	if [ ! -e "$(prefix)$(storage)" ]; then mkdir -p "$(prefix)$(storage)"; fi
	chmod 777 $(prefix)$(storage)
	chmod 666 $(prefix)$(datapath)/logs/glftpd.log
#	strip $(binpath)/*
	cp -f $(binpath)/zipscript-c $(bindir)/
	cp -f $(binpath)/postdel $(bindir)/
	cp -f $(binpath)/racestats $(bindir)/
	cp -f $(binpath)/cleanup $(bindir)/
	cp -f $(binpath)/datacleaner $(bindir)/
	cp -f $(binpath)/rescan $(bindir)/
	cp -f $(binpath)/racedebug $(bindir)/
	cp -f $(binpath)/pzsng-undupe $(bindir)/
	cp -f $(binpath)/ng-chmod $(bindir)/ && chmod +s $(bindir)/ng-chmod

distclean: clean
	$(RM) Makefile

clean:
	$(RM) *.o $(binpath)/zipscript-c $(binpath)/postdel $(binpath)/racestats $(binpath)/cleanup $(binpath)/datacleaner $(binpath)/rescan $(binpath)/racedebug $(binpath)/pzsng-undupe $(binpath)/ng-chmod

strip:
	strip $(binpath)/*

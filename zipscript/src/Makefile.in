prefix=@GLPATH@
datapath=/ftp-data
storage=/tmp/zipscript
bindir=$(prefix)/bin

CC=@CC@
CFLAGS=@CFLAGS@ -W -Wall @STATIC@ -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -I../include/ -I../../
LDFLAGS=@LDFLAGS@
UNIVERSAL=stats.o convert.o race-file.o zsfunctions.o mp3info.o
RM=@RM@ -f
INSTALL=@INSTALL@

RD-OBJECTS=racedebug.o
ZS-OBJECTS=zipscript-c.o dizreader.o complete.o multimedia.o crc.o $(UNIVERSAL)
PD-OBJECTS=postdel.o dizreader.o multimedia.o $(UNIVERSAL)
RS-OBJECTS=racestats.o dizreader.o $(UNIVERSAL)
CU-OBJECTS=cleanup.o
IL-OBJECTS=incomplete-list.o
DC-OBJECTS=datacleaner.o
UD-OBJECTS=pzsng-undupe.o
SC-OBJECTS=rescan.o dizreader.o complete.o crc.o multimedia.o $(UNIVERSAL)
CH-OBJECTS=ng-chown.o
ZS-DEPEND=cleanup.o incomplete-list.o complete.o datacleaner.o postdel.o racestats.o rescan.o zipscript-c.o multimedia.o $(UNIVERSAL)

all: pzsng-undupe racedebug zipscript-c postdel racestats cleanup datacleaner rescan ng-chown

$(ZS-DEPEND): ../conf/zsconfig.h

zipscript-c: $(ZS-OBJECTS) $(ZS-DEPEND)
	$(CC) $(CFLAGS) -o $@ $(ZS-OBJECTS)

racedebug: $(RD-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(RD-OBJECTS)

postdel: $(PD-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(PD-OBJECTS)

racestats: $(RS-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(RS-OBJECTS)

cleanup: $(CU-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(CU-OBJECTS)

datacleaner: $(DC-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(DC-OBJECTS)

pzsng-undupe: $(UD-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(UD-OBJECTS)

ng-chown: $(CH-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(CH-OBJECTS)

rescan: $(SC-OBJECTS)
	$(CC) $(CFLAGS) -o $@ $(SC-OBJECTS)

install:
	if [ ! -e "$(prefix)$(storage)" ]; then mkdir -p -m777 "$(prefix)$(storage)"; fi
	chown 0:0 $(prefix)$(storage)
	chmod 4777 $(prefix)$(storage)
	if [ -e $(prefix)$(datapath)/logs/glftpd.log ]; then chmod 666 $(prefix)$(datapath)/logs/glftpd.log; fi
	if [ -e $(bindir) ]; then cp -f zipscript-c postdel racestats cleanup datacleaner rescan racedebug pzsng-undupe ng-chown $(bindir)/; fi

distclean: clean

clean:
	$(RM) zipscript-c postdel racestats cleanup datacleaner rescan racedebug pzsng-undupe ng-chown

uninstall:
	rm -rf "$(prefix)$(storage)"
	rm -f $(bindir)/{zipscript-c,postdel,racestats,cleanup,datacleaner,rescan,racedebug,pzsng-undupe,ng-chown}

strip:
	strip zipscript-c postdel racestats cleanup datacleaner rescan racedebug pzsng-undupe ng-chown

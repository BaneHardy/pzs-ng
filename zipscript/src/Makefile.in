prefix		=	@GLPATH@
datapath	=	/ftp-data
storage		=	/ftp-data/pzs-ng
bindir		=	$(prefix)/bin

RM		=	@RM@ -f
INSTALL		=	@INSTALL@

CC		=	@CC@
CFLAGS		=	@CFLAGS@ @STATIC@ @NOFORMAT@ -D_FILE_OFFSET_BITS=64 \
			-D_LARGEFILE_SOURCE @DEFS@ -I../include/ -I../../ -I../../lib/
LDFLAGS		=	@LDFLAGS@ -L../../lib/libglufile
STRLCPY		=	../../lib/strl/strlcpy.o

SUNOBJS		=	@SUNOBJS@

UNIVERSAL 	=	stats.o convert.o race-file.o helpfunctions.o \
			zsfunctions.o mp3info.o ng-version.o abs2rel.o \
			$(SUNOBJS) $(STRLCPY)
		
ZSOBJECTS	=	zipscript-c.o dizreader.o complete.o multimedia.o \
			handle_sfv.o handle_nfo.o handle_zip.o \
			crc.o avinfo.o $(UNIVERSAL)
			
PDOBJECTS	=	postdel.o dizreader.o multimedia.o crc.o $(UNIVERSAL)

RSOBJECTS	=	racestats.o dizreader.o crc.o $(UNIVERSAL)

CUOBJECTS	=	cleanup.o

DCOBJECTS	=	datacleaner.o

UDOBJECTS	=	ng-undupe.o $(STRLCPY)

SCOBJECTS	=	rescan.o dizreader.o complete.o crc.o multimedia.o \
			$(UNIVERSAL)
			
CHOBJECTS	=	ng-chown.o

ZSDEPEND	=	cleanup.o complete.o datacleaner.o postdel.o \
			racestats.o rescan.o zipscript-c.o multimedia.o \
			$(UNIVERSAL)

all: 			ng-undupe zipscript-c postdel racestats cleanup \
			datacleaner rescan ng-chown

$(ZS-DEPEND): ../conf/zsconfig.h

strsep.o:
	$(CC) $(CFLAGS) -o strsep.o -c strsep.c
scandir.o:
	$(CC) $(CFLAGS) -o scandir.o -c scandir.c

zipscript-c: $(ZSOBJECTS) $(ZSDEPEND) $(SUNOBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(ZSOBJECTS) $(SUNOBJS) -lglufile

postdel: $(PDOBJECTS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(PDOBJECTS) -lglufile

racestats: $(RSOBJECTS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(RSOBJECTS) -lglufile

cleanup: $(CUOBJECTS)
	$(CC) $(CFLAGS) -o $@ $(CUOBJECTS) $(SUNOBJS)

datacleaner: $(DCOBJECTS)
	$(CC) $(CFLAGS) -o $@ $(DCOBJECTS) $(SUNOBJS)

ng-undupe: $(UDOBJECTS)
	$(CC) $(CFLAGS) -o $@ $(UDOBJECTS)

ng-chown: $(CHOBJECTS)
	$(CC) $(CFLAGS) -o $@ $(CHOBJECTS) $(SUNOBJS)

rescan: $(SCOBJECTS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(SCOBJECTS) -lglufile

install:
	if [ ! -e "$(prefix)$(storage)" ]; then mkdir -p -m777 "$(prefix)$(storage)"; fi
	chown 0:0 $(prefix)$(storage)
	chmod 4777 $(prefix)$(storage)
	if [ -e $(prefix)$(datapath)/logs/glftpd.log ]; then chmod 666 $(prefix)$(datapath)/logs/glftpd.log; fi
	if [ -e $(bindir) ]; then cp -f zipscript-c postdel racestats cleanup datacleaner rescan ng-undupe ng-chown $(bindir)/; fi
	if [ ! -e $(prefix)$(datapath)/misc/banned_filelist.txt ]; then cp ../conf/banned_filelist.txt $(prefix)$(datapath)/misc/banned_filelist.txt && chmod 444 $(prefix)$(datapath)/misc/banned_filelist.txt; fi

distclean: clean

clean:
	$(RM) zipscript-c postdel racestats cleanup datacleaner rescan ng-undupe ng-chown

uninstall:
	rm -rf "$(prefix)$(storage)"
	rm -f $(bindir)/{zipscript-c,postdel,racestats,cleanup,datacleaner,rescan,ng-undupe,ng-chown}

strip:
	strip zipscript-c postdel racestats cleanup datacleaner rescan ng-undupe ng-chown
